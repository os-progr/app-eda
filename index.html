<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero EDA (Cielo Estrellado Dinámico)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter (principal) y una fuente simulada para el Calendario (retro) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:ital,wght@700&display=swap" rel="stylesheet">
    <!-- Iconos de Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Librerías para conversión DOCX a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Definición de la paleta de colores oscuros */
        :root {
            /* Tono Base Oscuro - Más profundo para el cielo nocturno */
            --bg-primary: #0F0A19; /* Morado/Negro muy oscuro */
            --bg-secondary: #1E172B; /* Card/Component BG */
            --bg-tertiary: #332B45; /* Selected Tab BG */
            --text-light: #F0F0F0;
            --text-muted: #A0A0A0;
            --accent-pink: #FF66A3; /* Bright Pink FAB/Estrellas */
            --accent-blue: #70A0FF; /* Blue Logo/Énfasis */
            --border-color: #332B45; /* Borde más oscuro */
            
            /* Colores de Tarea/Nota */
            --color-blue: #70A0FF;
            --color-purple: #9333ea;
            --color-pink: #FF66A3;
            --color-yellow: #ca8a04;
            --color-green: #15803d;
            
            /* Colores Específicos del Calendario (Basado en la imagen anterior, pero ajustado) */
            --calendar-bg: #F0E6EF; /* Crema/Rosa claro */
            --calendar-day-bg: #E3D9E8; /* Beige suave */
            --calendar-accent-pink: #FF66A3; /* Rosa Retro */
            --calendar-font: 'Playfair Display', serif;
        }

        /* === Estilos de Fondo de Cielo Estrellado (Puro CSS) === */

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-light);
            transition: all 0.3s ease;
            min-height: 100vh; 
            margin: 0; 
            overflow-x: hidden; 
            background: linear-gradient(180deg, var(--bg-primary) 0%, #050309 100%); /* Degradado sutil */
            background-attachment: fixed;
        }
        
        /* Contenedores para el efecto de estrellas */
        #stars, #stars2, #stars3 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3; /* Detrás de la capa de contenido */
            pointer-events: none; /* No bloquear clics */
        }
        
        /* ... (Estilos de estrellas omitidos por brevedad, son los mismos que antes) ... */
        #stars {
            width: 1px; height: 1px; background: transparent;
            box-shadow: 20vw 50vh #fff, 80vw 20vh #fff, 10vw 80vh #fff, 90vw 40vh #fff, 50vw 90vh #fff, 30vw 10vh #fff, 70vw 60vh #fff, 5vw 30vh #fff, 95vw 75vh #fff, 40vw 5vh #fff, 12vw 15vh #fff, 75vw 85vh #fff, 35vw 45vh #fff, 60vw 15vh #fff, 85vw 55vh #fff, 25vw 70vh #fff, 65vw 25vh #fff, 55vw 80vh #fff, 15vw 5vh #fff, 80vw 90vh #fff, 5vw 95vh #fff, 90vw 10vh #fff, 30vw 60vh #fff, 70vw 30vh #fff, 45vw 70vh #fff, 10vw 40vh #fff, 95vw 15vh #fff, 20vw 85vh #fff, 80vw 5vh #fff, 50vw 35vh #fff;
            color: var(--accent-pink); 
            animation: move-stars 100s linear infinite;
        }
        #stars2 {
             width: 2px; height: 2px; background: transparent;
             box-shadow: 40vw 15vh var(--accent-blue), 10vw 65vh #fff, 85vw 35vh #fff, 25vw 55vh #fff, 55vw 5vh var(--accent-pink), 75vw 95vh #fff, 15vw 25vh #fff, 95vw 45vh #fff, 65vw 70vh var(--accent-blue), 35vw 90vh #fff;
             animation: move-stars 150s linear infinite reverse;
        }
        #stars3 {
             width: 3px; height: 3px; background: transparent;
             box-shadow: 5vw 10vh var(--accent-pink), 90vw 90vh #fff, 45vw 20vh var(--accent-blue), 70vw 40vh #fff;
             animation: move-stars 200s linear infinite;
        }
        @keyframes move-stars {
            from { transform: translateX(0) translateY(0); }
            to { transform: translateX(-100px) translateY(-100px); }
        }
        
        /* Capa oscura semi-transparente sobre las estrellas */
        #app-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 10, 25, 0.75); 
            z-index: -1; 
        }

        /* === Fin Estilos de Fondo === */

        /* Utilidades de color */
        .bg-primary { background-color: transparent; } /* Reemplazado por el efecto de capa */
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .border-base { border-color: var(--border-color); }
        .accent-pink-bg { background-color: var(--accent-pink); }
        .accent-pink-text { color: var(--accent-pink); }
        .accent-blue-text { color: var(--accent-blue); }

        /* Contenedor principal de la aplicación - Modo Mobile y Base Vertical */
        .app-layout-container {
            min-height: 100vh;
            width: 100%; 
            padding: 0; /* Ocupar todo el espacio */
        }
        
        .app-content-wrapper {
            width: 100%;
            min-height: 100vh; 
            height: 100vh; /* Fija la altura total del viewport */
            display: flex;
            flex-direction: column; /* Diseño vertical por defecto */
            padding: 0;
            max-width: none;
            overflow-y: hidden; /* El scroll lo maneja el main-content-area */
        }
        
        /* === ESTILOS ESPECÍFICOS PARA EL LAYOUT WEB (md: breakpoint y superior) === */
        @media (min-width: 768px) {
            
            /* Ocultar el nav lateral que era de diseño horizontal */
            .sidebar-nav {
                display: none !important;
            }
            
            /* El header y el nav horizontal se ajustan a todo el ancho */
            #header-mobile {
                padding: 1rem 2rem; /* Añade padding horizontal */
                background-color: var(--bg-secondary); /* Asegura que el header sea opaco */
            }
            #nav-tabs {
                display: flex !important; /* Asegura que la barra de tabs se vea */
                border-radius: 0; /* Sin bordes redondeados para la barra superior */
                padding: 1rem 2rem; /* Más padding para desktop */
                border-bottom: 1px solid var(--border-color);
                background-color: var(--bg-secondary); /* Asegura que el nav sea opaco */
            }
            
            /* El área de contenido principal gestiona el scroll y el padding */
            .main-content-area {
                flex-grow: 1; /* El contenido toma el espacio restante */
                overflow-y: auto; /* Permite el scroll del contenido */
                padding: 2rem 4rem 4rem 4rem; /* Padding amplio para desktop */
            }
            
            /* FAB se mantiene en la misma posición relativa */
            .fab {
                right: 40px; 
                bottom: 40px; 
            }
            
            /* Estilo de los tabs para desktop (ahora en la barra horizontal) */
            #nav-tabs .nav-tab {
                 padding: 0.75rem 1.5rem;
                 margin-right: 0.5rem;
                 /* Eliminar el margen en mobile si existiera para que queden juntos */
                 margin-bottom: 0; 
            }
        }
        
        /* Ajustes de Mobile: el padding general se aplica al wrapper de contenido */
        @media (max-width: 767px) {
            .main-content-area {
                /* Padding para mobile */
                padding: 1rem;
                flex-grow: 1;
                overflow-y: auto;
            }
            
            /* Ajuste del nav en mobile para centrar los iconos */
            #nav-tabs .nav-tab {
                padding: 0.5rem;
                text-align: center;
            }
            /* Asegurar que el header y el nav de mobile tengan fondo opaco */
            #header-mobile, #nav-tabs {
                background-color: var(--bg-secondary);
            }
        }


        /* Estilos de la Tarea/Elemento de Lista - NUEVO DISEÑO SIMPLE */
        .task-item {
            background-color: transparent; 
            border-bottom: 1px solid var(--border-color); 
            transition: all 0.2s;
        }
        .task-item:hover {
            background-color: #332B45; /* Tono más oscuro para el hover */
        }
        .task-checked {
            text-decoration: line-through;
            color: var(--text-muted) !important;
        }
        /* Ajuste del checkbox para que coincida con el estilo de la imagen */
        .task-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-light); 
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            background-color: transparent;
            position: relative;
        }
        .task-checkbox:checked {
            border-color: var(--accent-pink); 
            background-color: var(--accent-pink);
        }
        .task-checkbox:checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }


        /* Estilos del Calendario (Diseño Retro/Kawaii) */
        .calendar-container {
            background-color: var(--calendar-bg);
            color: #4B4B4B; 
            padding: 1.5rem;
            border-radius: 12px;
            font-family: var(--calendar-font);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }
        .calendar-title {
            color: var(--calendar-accent-pink);
            font-size: 2.5rem;
            line-height: 1;
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day-header {
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            color: #555;
            padding: 4px 0;
        }
        .calendar-day-box {
            background-color: var(--calendar-day-bg);
            border-radius: 6px;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calendar-day-box:hover {
            background-color: #D6C9D1;
        }
        .calendar-day-box.accent {
            background-color: var(--calendar-accent-pink);
            color: white;
        }
        .calendar-note-box {
            background-color: var(--calendar-day-bg);
            border: 2px solid var(--calendar-accent-pink);
            border-radius: 12px;
            padding: 1rem;
            min-height: 150px;
            font-size: 0.9rem;
            color: #4B4B4B;
        }
        .calendar-note-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--calendar-accent-pink);
            margin-bottom: 0.5rem;
        }

        /* Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            z-index: 20;
        }
        .fab:hover {
            transform: scale(1.05);
        }
        
        /* Estilos específicos para inputs oscuros y Date/Time */
        .dark-input {
            background-color: var(--bg-primary); /* Usamos el color base oscuro (sin opacidad) */
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        /* ESTILO NUEVO PARA EL INPUT DE FECHA */
        .dark-input.date-placeholder {
            background-color: #1a1a1e; 
            border: 1px dashed #404040; 
            color: var(--text-muted); 
            text-align: left; 
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: none;
            color: var(--text-muted); 
            opacity: 1;
            cursor: pointer;
            width: 1.5rem;
            height: 1.5rem;
        }
        
        /* Color de los puntos de color */
        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }
        .color-dot.selected {
            border-color: var(--text-light);
            box-shadow: 0 0 0 2px var(--bg-secondary);
        }
        
        /* Estilos para las Notas (Basado en la imagen de post-its) */
        .note-card {
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            border-top: 5px solid rgba(0, 0, 0, 0.1); 
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* Colores basados en la imagen (tonos pastel) */
        .note-beige { background-color: #EDE8D3; color: #4B4B4B; }
        .note-pink { background-color: #F7DDE6; color: #4B4B4B; }
        .note-orange { background-color: #F9E0C2; color: #4B4B4B; } 
        .note-light-blue { background-color: #D3E8ED; color: #4B4B4B; }
        
        /* Estilo del textarea dentro de la nota */
        .note-textarea {
            resize: none;
            min-height: 100px;
            color: inherit !important; 
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif; 
        }
        
        /* Estilo para los botones de acción en las notas (oscuros sobre claro) */
        .note-action-btn {
            color: #4B4B4B; 
            background-color: rgba(255, 255, 255, 0.5); 
            border-radius: 50%;
            padding: 4px;
            transition: all 0.2s;
        }
        .note-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* === ESTILOS PARA EL CONVERTIDOR DOCX (SIMULADO) === */
        #drop-zone {
            border: 2px dashed var(--border-color);
            background-color: var(--bg-secondary);
            transition: all 0.3s;
        }
        #drop-zone.drag-over {
            border-color: var(--accent-pink);
            background-color: var(--bg-tertiary);
        }
        /* Ocultar el input de archivo real */
        #file-input {
            display: none;
        }
        
    </style>
    
</head>
<body class="bg-primary">
    
    <!-- Capa 1: Estrellas Pequeñas y Densas (box-shadow CSS) -->
    <div id="stars"></div>
    <!-- Capa 2: Estrellas Medianas y Brillantes -->
    <div id="stars2"></div>
    <!-- Capa 3: Estrellas Grandes o Planetas (Paralaje Lento) -->
    <div id="stars3"></div>

    <!-- Contenedor principal de la aplicación: Ocupa toda la pantalla -->
    <div id="app-container" class="app-layout-container w-full">
        
        <!-- Pantalla de Carga (Oculta al inicio) -->
        <div id="loading-screen" class="fixed inset-0 bg-primary/90 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="flex flex-col items-center">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 accent-pink-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-light">Cargando aplicación...</p>
            </div>
        </div>


        <!-- Tablero de Productividad (Dashboard) -->
        <div id="dashboard-screen" class="app-content-wrapper hidden">
            
            <!-- Bloque Lateral (Sidebar) para Desktop (Ahora oculto en layout vertical) -->
            <div class="sidebar-nav hidden md:hidden bg-secondary">
                <!-- Contenido de Sidebar... -->
            </div>

            <!-- Header Superior (Logo y Usuario) - Visible en ambos layouts -->
            <header id="header-mobile" class="flex items-center justify-between bg-secondary p-4 flex-shrink-0">
                <div class="flex items-center">
                    <i data-lucide="monitor" class="w-6 h-6 accent-blue-text mr-2"></i>
                    <h1 class="text-xl font-extrabold text-light">EDA</h1>
                </div>
                <!-- CONTENEDOR DE USUARIO Y CIERRE DE SESIÓN -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-muted">
                        <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                        <p id="user-display" class="truncate max-w-[100px]">Hola, Usuario</p>
                    </div>
                    <!-- BOTÓN DE CERRAR SESIÓN MOVIDO AQUÍ -->
                    <button id="logout-btn" class="text-sm text-muted hover:text-red-400 transition" title="Cerrar Sesión">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- Navegación de Pestañas Horizontal (Ahora visible en Mobile y Desktop) -->
            <nav id="nav-tabs" class="flex justify-around bg-secondary flex-shrink-0 border-b border-base md:justify-start">
                <!-- Se crearán los botones de pestaña con JS -->
            </nav>


            <!-- Área de Scroll Principal (Contenido de las Pestañas) -->
            <main id="tab-content-container" class="main-content-area flex-grow overflow-y-auto relative">
                
                <!-- Contenido 1: Tareas -->
                <div id="tasks-tab" class="tab-panel">
                    <h2 class="text-2xl font-extrabold text-light mb-1">Hacer</h2> 
                    <p id="tasks-count" class="text-muted text-sm mb-4">0 pendientes</p>
                    <ul id="task-list" class="space-y-0 divide-y divide-border-color">
                        <!-- Las tareas se inyectarán aquí -->
                        <div id="task-empty-state" class="text-center mt-12 text-muted">
                            <i data-lucide="clipboard-list" class="w-10 h-10 mx-auto mb-3"></i>
                            <p class="text-lg font-medium">No tienes tareas aún.</p>
                            <p class="text-sm">Toca el <span class="accent-pink-text font-bold">+</span> para empezar.</p>
                        </div>
                    </ul>
                </div>

                <!-- Contenido 2: Notas -->
                <div id="notes-tab" class="tab-panel hidden">
                    <h2 class="text-2xl font-extrabold text-light mb-4">Mis Notas</h2>
                    <!-- Grid adaptable a desktop: 3 columnas, 1 en mobile -->
                    <div id="notes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> 
                        <!-- Las notas se inyectarán aquí -->
                        <div id="notes-empty-state" class="text-center mt-12 text-muted md:col-span-full">
                            <i data-lucide="notebook-text" class="w-10 h-10 mx-auto mb-3"></i>
                            <p class="text-lg font-medium">No tienes notas.</p>
                            <p class="text-sm">Toca el <span class="accent-pink-text font-bold">+</span> para empezar a escribir.</p>
                        </div>
                    </div>
                </div>

                <!-- Contenido 3: Calendario -->
                <div id="calendar-tab" class="tab-panel hidden">
                    <div id="calendar-view" class="calendar-container p-6 w-full max-w-full">
                        <h2 class="calendar-title">Noviembre</h2>
                        <span class="text-sm font-semibold block -mt-2 mb-3 text-red-500">2025 (Mockup Retro)</span>

                        <!-- Contenedor Principal: Notas y Calendario -->
                        <!-- En layout vertical, se apilan por defecto (col-span-full) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> 
                            <!-- Bloque de Notas del Mes -->
                            <div class="space-y-4 md:col-span-full">
                                <div class="calendar-note-box p-4 bg-yellow-100/70 border-yellow-500 relative overflow-hidden">
                                    <h4 class="calendar-note-title text-yellow-700">Deseos este mes</h4>
                                    <textarea placeholder="Escribe tus metas..." class="w-full bg-transparent resize-none h-24 p-0 outline-none text-sm"></textarea>
                                </div>
                                <div class="calendar-note-box p-4 bg-red-100/70 border-red-500 relative overflow-hidden">
                                    <h4 class="calendar-note-title text-red-700">Anotaciones</h4>
                                    <textarea placeholder="Recordatorios importantes..." class="w-full bg-transparent resize-none h-24 p-0 outline-none text-sm"></textarea>
                                </div>
                            </div>
                            
                            <!-- Grid del Calendario (Ahora ocupa todo el ancho) -->
                            <div class="md:col-span-full">
                                <div class="calendar-grid mb-2">
                                    <!-- Días de la semana -->
                                    <div class="calendar-day-header">Dom</div>
                                    <div class="calendar-day-header">Lun</div>
                                    <div class="calendar-day-header">Mar</div>
                                    <div class="calendar-day-header">Mié</div>
                                    <div class="calendar-day-header">Jue</div>
                                    <div class="calendar-day-header">Vie</div>
                                    <div class="calendar-day-header">Sáb</div>
                                    
                                    <!-- Días del Mes (Nov 2025) - Simulado -->
                                    <div class="calendar-day-box bg-transparent !shadow-none"></div><div class="calendar-day-box bg-transparent !shadow-none"></div><div class="calendar-day-box bg-transparent !shadow-none"></div><div class="calendar-day-box bg-transparent !shadow-none"></div><div class="calendar-day-box bg-transparent !shadow-none"></div>
                                    <div class="calendar-day-box">1</div>
                                    <div class="calendar-day-box accent">2</div><div class="calendar-day-box">3</div><div class="calendar-day-box">4</div><div class="calendar-day-box">5</div><div class="calendar-day-box">6</div><div class="calendar-day-box">7</div><div class="calendar-day-box">8</div>
                                    <div class="calendar-day-box">9</div><div class="calendar-day-box">10</div><div class="calendar-day-box">11</div><div class="calendar-day-box">12</div><div class="calendar-day-box">13</div><div class="calendar-day-box">14</div><div class="calendar-day-box">15</div>
                                    <div class="calendar-day-box">16</div><div class="calendar-day-box">17</div><div class="calendar-day-box">18</div><div class="calendar-day-box">19</div><div class="calendar-day-box">20</div><div class="calendar-day-box accent">21</div> 
                                    <div class="calendar-day-box">22</div><div class="calendar-day-box">23</div><div class="calendar-day-box">24</div><div class="calendar-day-box">25</div><div class="calendar-day-box">26</div><div class="calendar-day-box">27</div><div class="calendar-day-box">28</div>
                                    <div class="calendar-day-box">29</div><div class="calendar-day-box">30</div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 bg-calendar-day-bg p-3 rounded-lg text-center font-bold">
                            Frase para noviembre
                        </div>
                    </div>
                </div>

                <!-- Contenido 4: Convertidor DOCX a PDF (Simulado) -->
                <div id="converter-tab" class="tab-panel hidden">
                    <h2 class="text-2xl font-extrabold text-light mb-4">Convertir DOCX a PDF</h2>
                    <div class="bg-secondary p-6 rounded-xl w-full max-w-lg mx-auto border border-base">
                        
                        <!-- Zona de Carga -->
                        <label id="drop-zone" for="file-input" class="flex flex-col items-center justify-center w-full h-48 rounded-lg cursor-pointer p-4 text-center">
                            <i data-lucide="file-up" class="w-12 h-12 text-muted mb-3"></i>
                            <span class="font-semibold text-light">Haz clic o arrastra un archivo .docx</span>
                            <span class="text-sm text-muted">Arrastra o selecciona un archivo .docx para convertir.</span>
                        </label>
                        <input id="file-input" type="file" accept=".docx, application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        
                        <!-- Nombre del archivo seleccionado -->
                        <p id="file-name" class="text-center text-muted text-sm mt-4 truncate"></p>

                        <!-- Botón de Conversión -->
                        <button id="convert-btn" class="w-full accent-pink-bg hover:bg-pink-600 text-white font-semibold py-3 rounded-lg transition duration-200 mt-6 flex items-center justify-center" disabled>
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                            Convertir
                        </button>
                        
                        <!-- Estado de Carga -->
                        <div id="convert-loading" class="mt-6 flex items-center justify-center text-light hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Convirtiendo archivo (simulación)...</span>
                        </div>
                        
                        <!-- Estado de Éxito -->
                        <div id="convert-success" class="mt-6 p-4 bg-green-900/50 border border-green-500 rounded-lg text-center hidden">
                            <p class="font-semibold text-green-300">¡Conversión Exitosa!</p>
                            <p class="text-sm text-green-200 mt-1">Tu archivo PDF se ha descargado automáticamente.</p>
                            <p class="text-xs text-green-300 mt-2 opacity-75">Revisa tu carpeta de descargas.</p>
                        </div>
                    </div>
                </div>

            </main>
            
            <!-- Floating Action Button (FAB) -->
            <!-- ESTE ES EL BOTÓN PARA AGREGAR NOTAS (cuando estás en la pestaña de Notas) o TAREAS (cuando estás en la pestaña de Tareas) -->
            <button id="fab-btn" class="fab accent-pink-bg text-white">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
            
            <!-- Modal de Entrada/Edición (Input Modal) -->
            <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
                <div class="bg-primary p-6 rounded-xl shadow-2xl w-full max-w-sm border border-base max-h-[90vh] overflow-y-auto">
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="input-modal-title" class="text-2xl font-extrabold text-light">Nueva Tarea</h3>
                        <button id="cancel-input-btn" class="p-1 text-muted hover:text-light transition">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <form id="task-note-form" class="space-y-6">
                        
                        <!-- TÍTULO / CONTENIDO -->
                        <div id="title-field">
                            <label for="input-title" class="text-sm font-semibold block mb-2 text-muted" id="input-title-label">TÍTULO</label>
                            <textarea id="input-title" placeholder="Ej. Comprar leche" required 
                                class="dark-input focus:ring-2 focus:ring-accent-blue focus:border-accent-blue h-12 resize-none pt-2"
                                rows="1" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
                        </div>

                        <!-- FECHA Y HORA (Con mini-calendario nativo) - Tareas solamente -->
                        <div id="date-field" class="hidden">
                            <label for="input-date" class="text-sm font-semibold block mb-2 text-muted">FECHA</label>
                            <input type="datetime-local" id="input-date" 
                                class="dark-input date-placeholder focus:ring-2 focus:ring-accent-blue focus:border-accent-blue"
                                placeholder="dd/mm/aaaa --:--">
                        </div>

                        <!-- ADJUNTOS (Simulado) - Tareas y Notas -->
                        <div id="attachments-field" class="hidden">
                            <label class="text-sm font-semibold block mb-3 text-muted">ADJUNTOS</label>
                            <div class="flex space-x-4">
                                <button type="button" onclick="simulateAttachment('Foto')" class="flex-1 bg-primary/70 border border-dashed border-gray-600 rounded-lg p-4 flex flex-col items-center text-muted hover:border-accent-pink transition" title="Cámara (Simulado)">
                                    <i data-lucide="camera" class="w-6 h-6"></i>
                                    <span class="text-xs mt-1">Cámara</span>
                                </button>
                                <button type="button" onclick="simulateAttachment('Documento')" class="flex-1 bg-primary/70 border border-dashed border-gray-600 rounded-lg p-4 flex flex-col items-center text-muted hover:border-accent-pink transition" title="Archivo (Simulado)">
                                    <i data-lucide="folder-open" class="w-6 h-6"></i>
                                    <span class="text-xs mt-1">Archivo</span>
                                </button>
                            </div>
                            <div id="attached-files-list" class="mt-4 space-y-2">
                                <!-- Archivos adjuntos simulados se inyectarán aquí -->
                            </div>
                        </div>

                        <!-- COLOR (Usado para Notas) -->
                        <div>
                            <label class="text-sm font-semibold block mb-3 text-muted">COLOR</label>
                            <div id="color-selector" class="flex space-x-3">
                                <!-- Colores inyectados por JS -->
                            </div>
                        </div>
                        
                        <!-- BOTÓN DE ACCIÓN -->
                        <button type="submit" id="confirm-input-btn" class="w-full bg-secondary hover:bg-tertiary text-white font-semibold py-3 rounded-lg transition duration-200">
                            Crear Elemento
                        </button>
                    </form>
                </div>
            </div>


            <!-- Modal de Confirmación de Eliminación -->
            <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-secondary p-6 rounded-xl shadow-2xl w-full max-w-xs border border-base">
                    <h3 class="text-xl font-bold mb-4 text-red-400">Confirmar Eliminación</h3>
                    <p class="text-light mb-6" id="delete-modal-text">¿Estás seguro de que deseas eliminar este elemento?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete-btn" class="bg-gray-700 hover:bg-gray-600 text-light font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Cancelar
                        </button>
                        <button id="confirm-delete-btn" data-doc-id="" data-type="" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Script de Firebase (Módulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================
        // 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
        // =========================================================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false; 
        let listenersInitialized = false; 
        let currentTab = 'tasks'; 
        let currentDocId = null; // Para edición: almacena el ID del documento a editar
        let useLocalStorage = false; // Flag para usar localStorage cuando Firebase no esté disponible
        
        const loadingScreen = document.getElementById('loading-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const userDisplay = document.getElementById('user-display');
        const tabContentContainer = document.getElementById('tab-content-container');

        // Intentar activar logs de Firebase solo si está disponible
        try {
            setLogLevel('debug');
        } catch (e) {
            console.log('Firebase no disponible, usando modo local');
        }

        // Colores para las notas y el selector de color del modal
        const NOTE_PASTEL_COLORS = {
            'beige': '#EDE8D3',
            'pink': '#F7DDE6',
            'orange': '#F9E0C2',
            'light-blue': '#D3E8ED'
        };
        const NOTE_BACKGROUND_CLASSES = {
             'beige': 'note-beige',
             'pink': 'note-pink',
             'orange': 'note-orange',
             'light-blue': 'note-light-blue',
        };
        const DEFAULT_TASK_COLOR = '#70A0FF'; // Azul de acento para tareas

        // CONFIGURACIÓN DE PESTAÑAS ACTUALIZADA
        const TAB_CONFIG = {
            'tasks': { icon: 'clipboard-list', title: 'Tareas' }, 
            'calendar': { icon: 'calendar-days', title: 'Calendario' },
            'notes': { icon: 'notebook-text', title: 'Notas' },
            'converter': { icon: 'file-axis-3d', title: 'Convertir' }, // "Ajustes" ahora es "Convertir"
        };
        
        // Estado temporal para los archivos adjuntos simulados
        let simulatedAttachments = []; 

        async function initializeFirebase() {
            loadingScreen.classList.remove('hidden');
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    throw new Error("Configuración de Firebase no disponible.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Manejar el estado de autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        useLocalStorage = false;
                        
                        // Mostrar UI de Dashboard
                        userDisplay.textContent = `Hola, Usuario (${userId.substring(0, 4)})`; 
                        dashboardScreen.classList.remove('hidden');

                        setupFirestoreListeners();
                        lucide.createIcons();

                    } else {
                        // Si no hay usuario, autenticar automáticamente de forma anónima
                        await signInAnonymously(auth);
                    }
                    loadingScreen.classList.add('hidden');
                });

                // 2. Intentar autenticación con el token proporcionado o de forma anónima automáticamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Autenticar automáticamente de forma anónima sin mostrar pantalla de login
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.warn("Firebase no disponible, usando almacenamiento local:", error);
                useLocalStorage = true;
                userId = 'local-user-' + Date.now();
                isAuthReady = true;
                userDisplay.textContent = 'Hola, Usuario (Local)';
                dashboardScreen.classList.remove('hidden');
                loadingScreen.classList.add('hidden');
                setupLocalStorageListeners();
                lucide.createIcons();
            }
        }

        // Llamar a la función de inicialización cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
             // Mostrar el dashboard inmediatamente
             dashboardScreen.classList.remove('hidden');
             loadingScreen.classList.add('hidden');
             
             initializeFirebase();
             renderTabs('nav-tabs'); // Renderizado móvil (y ahora desktop)
             
             // Determinar la pestaña inicial y cambiar
             currentTab = 'tasks'; 
             switchTab(currentTab); 
             
             // Evento para cerrar sesión (ahora en el header)
             document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                }
            });
             
             // Inicializar la lógica del convertidor simulado
             initConverter();
             
             // Listener de redimensionamiento para manejar el layout de desktop/mobile
             window.addEventListener('resize', () => switchTab(currentTab));

        });


        // =========================================================
        // 2. LÓGICA DE FIREBASE FIRESTORE (CRUD)
        // =========================================================

        const getCollectionRef = (collectionName) => {
            // Ruta: /artifacts/{appId}/users/{userId}/{collectionName}
            // userId se obtiene automáticamente de la autenticación anónima
            if (useLocalStorage || !db) {
                return null; // No usar Firestore si estamos en modo local
            }
            return collection(db, 'artifacts', appId, 'users', userId, collectionName);
        };

        // =========================================================
        // ALMACENAMIENTO LOCAL (localStorage) como respaldo
        // =========================================================
        
        function getLocalStorageKey(collectionName) {
            return `eda_${collectionName}_${userId}`;
        }
        
        function loadFromLocalStorage(collectionName) {
            try {
                const key = getLocalStorageKey(collectionName);
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('Error al cargar desde localStorage:', e);
                return [];
            }
        }
        
        function saveToLocalStorage(collectionName, items) {
            try {
                const key = getLocalStorageKey(collectionName);
                localStorage.setItem(key, JSON.stringify(items));
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
            }
        }
        
        function setupLocalStorageListeners() {
            // Cargar y mostrar tareas
            const tasks = loadFromLocalStorage('tasks');
            renderTasks(tasks);
            
            // Cargar y mostrar notas
            const notes = loadFromLocalStorage('notes');
            renderNotes(notes);
        }
        
        function renderTasks(tasks) {
            taskList.innerHTML = '';
            const pendingCount = tasks.filter(t => !t.completed).length;
            tasksCountDisplay.textContent = `${pendingCount} pendiente${pendingCount === 1 ? '' : 's'}`;
            
            if (tasks.length === 0) {
                taskEmptyState.classList.remove('hidden');
            } else {
                taskEmptyState.classList.add('hidden');
                tasks.sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });
                tasks.forEach(task => {
                    taskList.appendChild(createTaskElement(task));
                });
            }
            lucide.createIcons();
        }
        
        function renderNotes(notes) {
            notesGrid.innerHTML = '';
            if (notes.length === 0) {
                notesEmptyState.classList.remove('hidden');
            } else {
                notesEmptyState.classList.add('hidden');
                notes.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                notes.forEach(note => {
                    notesGrid.appendChild(createNoteElement(note));
                });
            }
            notesGrid.querySelectorAll('.note-textarea').forEach(textarea => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            lucide.createIcons();
        }

        // --- TAREAS (Tasks) ---

        const taskList = document.getElementById('task-list');
        const tasksCountDisplay = document.getElementById('tasks-count');
        const taskEmptyState = document.getElementById('task-empty-state');
        
        /**
         * Simulación de compartir tarea.
         */
        function shareTask(title) {
            const shareText = `¡Mira mi nueva tarea en EDA: "${title}"!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Compartir Tarea',
                    text: shareText,
                }).then(() => {
                    showMessageModal("Tarea compartida exitosamente.", "Éxito");
                }).catch((error) => {
                    console.error("Error al compartir:", error);
                    showMessageModal(`No se pudo usar el compartir nativo. El contenido se ha copiado al portapapeles.`, "Compartir");
                    
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                });
            } else {
                 showMessageModal(`Compartir (Simulado). El contenido de la tarea se ha copiado al portapapeles: "${shareText}"`, "Compartir");

                 const tempInput = document.createElement('textarea');
                 tempInput.value = shareText;
                 document.body.appendChild(tempInput);
                 tempInput.select();
                 document.execCommand('copy');
                 document.body.removeChild(tempInput);
            }
        }


        /**
         * Crea un elemento de lista para una tarea.
         * @param {object} task - Datos de la tarea.
         */
        const createTaskElement = (task) => {
            const li = document.createElement('li');
            li.className = 'task-item flex items-center justify-between py-3 px-1'; 
            li.dataset.id = task.id;

            const content = document.createElement('div');
            content.className = 'flex items-center flex-1 min-w-0 mr-4'; 

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.completed;
            checkbox.className = 'task-checkbox'; 
            checkbox.addEventListener('change', () => toggleTaskCompletion(task.id, checkbox.checked));

            const textContainer = document.createElement('div');
            textContainer.className = 'ml-4 break-words flex-1 min-w-0';

            const title = document.createElement('span');
            title.textContent = task.title;
            title.className = `block text-base font-medium ${task.completed ? 'task-checked' : 'text-light'}`;
            
            textContainer.appendChild(title); // Añadir el título primero

            if (task.dueDate) {
                const date = document.createElement('span');
                // Convertir Timestamp a objeto Date para formatear (puede ser Timestamp de Firestore o Date normal)
                let dateObj;
                if (task.dueDate && typeof task.dueDate.toDate === 'function') {
                    dateObj = task.dueDate.toDate();
                } else if (task.dueDate instanceof Date) {
                    dateObj = task.dueDate;
                } else if (typeof task.dueDate === 'number' || typeof task.dueDate === 'string') {
                    dateObj = new Date(task.dueDate);
                } else {
                    dateObj = null;
                }
                
                if (dateObj && !isNaN(dateObj.getTime())) {
                    const formattedDate = dateObj.toLocaleDateString('es-ES', { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                    });
                    date.textContent = `Vence: ${formattedDate}`;
                    date.className = 'block text-xs text-muted mt-1';
                    textContainer.appendChild(date);
                }
            }
            
            const actions = document.createElement('div');
            actions.className = 'flex space-x-2 flex-shrink-0';
            
            // 1. Botón de Compartir
            const shareBtn = document.createElement('button');
            shareBtn.innerHTML = '<i data-lucide="share-2" class="w-5 h-5 text-muted hover:text-accent-blue"></i>';
            shareBtn.className = 'p-1 rounded-full transition';
            shareBtn.title = 'Compartir Tarea';
            shareBtn.onclick = () => shareTask(task.title);

            // 2. Botón de Eliminar
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5 text-muted hover:text-red-400"></i>';
            deleteBtn.className = 'p-1 rounded-full transition';
            deleteBtn.title = 'Eliminar Tarea';
            deleteBtn.onclick = () => openDeleteModal(task.id, 'task', `¿Eliminar "${task.title.substring(0, 30)}..."?`);

            actions.appendChild(shareBtn);
            actions.appendChild(deleteBtn);

            content.appendChild(checkbox);
            content.appendChild(textContainer);
            
            li.appendChild(content);
            li.appendChild(actions); 

            lucide.createIcons();
            return li;
        };

        async function toggleTaskCompletion(taskId, completed) {
            try {
                if (useLocalStorage) {
                    const tasks = loadFromLocalStorage('tasks');
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        tasks[taskIndex].completed = completed;
                        saveToLocalStorage('tasks', tasks);
                        renderTasks(tasks);
                    }
                } else {
                    const taskRef = doc(getCollectionRef('tasks'), taskId);
                    await updateDoc(taskRef, { completed: completed });
                }
            } catch (error) {
                console.error("Error al actualizar tarea:", error);
            }
        }

        /**
         * Agrega una nueva tarea a Firestore o localStorage con todos los campos.
         */
        async function saveTask(title, dateString, attachments) {
            if (!title.trim()) return;
            
            let dueDate = null;
            if (dateString) {
                dueDate = new Date(dateString); 
                if (isNaN(dueDate.getTime())) {
                    dueDate = null;
                }
            }
            
            const taskData = {
                title: title.trim(),
                dueDate: dueDate,
                attachments: attachments || [],
                color: DEFAULT_TASK_COLOR, 
            };

            try {
                if (useLocalStorage) {
                    const tasks = loadFromLocalStorage('tasks');
                    if (currentDocId) {
                        // Edición
                        const taskIndex = tasks.findIndex(t => t.id === currentDocId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                            saveToLocalStorage('tasks', tasks);
                            renderTasks(tasks);
                        }
                    } else {
                        // Creación
                        const newTask = {
                            id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            ...taskData,
                            completed: false,
                            createdAt: Date.now(),
                        };
                        tasks.push(newTask);
                        saveToLocalStorage('tasks', tasks);
                        renderTasks(tasks);
                    }
                } else {
                    if (currentDocId) {
                        // Edición
                        const taskRef = doc(getCollectionRef('tasks'), currentDocId);
                        await updateDoc(taskRef, taskData);
                    } else {
                        // Creación
                        await addDoc(getCollectionRef('tasks'), {
                            ...taskData,
                            completed: false,
                            createdAt: serverTimestamp(),
                        });
                    }
                }
            } catch (error) {
                console.error("Error al guardar tarea:", error);
                showMessageModal("No se pudo guardar la tarea.", "Error");
            }
        }

        // --- NOTAS (Notes) ---

        const notesGrid = document.getElementById('notes-grid');
        const notesEmptyState = document.getElementById('notes-empty-state');
        
        /**
         * Guarda una nueva nota o edita una existente.
         */
        async function saveNote(content, colorName, attachments) {
             if (!content.trim()) return;
             
             const noteData = {
                 content: content.trim(), 
                 color: NOTE_BACKGROUND_CLASSES[colorName] || NOTE_BACKGROUND_CLASSES.beige,
                 attachments: attachments || [],
                 updatedAt: useLocalStorage ? Date.now() : serverTimestamp(),
             };

             try {
                 if (useLocalStorage) {
                     const notes = loadFromLocalStorage('notes');
                     if (currentDocId) {
                         // Edición
                         const noteIndex = notes.findIndex(n => n.id === currentDocId);
                         if (noteIndex !== -1) {
                             notes[noteIndex] = { ...notes[noteIndex], ...noteData };
                             saveToLocalStorage('notes', notes);
                             renderNotes(notes);
                         }
                     } else {
                         // Creación
                         const newNote = {
                             id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                             ...noteData,
                             createdAt: Date.now(),
                         };
                         notes.push(newNote);
                         saveToLocalStorage('notes', notes);
                         renderNotes(notes);
                     }
                 } else {
                     if (currentDocId) {
                         // Edición (aunque la edición principal es inline, esto es para el modal)
                         const noteRef = doc(getCollectionRef('notes'), currentDocId);
                         await updateDoc(noteRef, noteData);
                     } else {
                         // Creación
                         await addDoc(getCollectionRef('notes'), {
                             ...noteData,
                             createdAt: serverTimestamp(),
                         });
                     }
                 }
             } catch (error) {
                 console.error("Error al guardar nota:", error);
                 showMessageModal("No se pudo guardar la nota.", "Error");
             }
        }

        // Genera el HTML para una nota
        const createNoteElement = (note) => {
            const div = document.createElement('div');
            // Usamos la clase de color guardada en Firebase
            div.className = `note-card ${note.color} p-4 rounded-xl relative flex flex-col`;
            div.dataset.id = note.id;

            const textarea = document.createElement('textarea');
            textarea.value = note.content;
            textarea.className = `note-textarea w-full bg-transparent border-none focus:ring-0 p-0 leading-relaxed outline-none placeholder:opacity-70 flex-grow`;
            textarea.placeholder = "Escribe tu nota...";
            
            // --- Lógica de Auto-guardado y Auto-redimensionamiento ---
            let timeoutId;
            const autoResize = (e) => {
                e.style.height = 'auto';
                e.style.height = e.scrollHeight + 'px';
            };
            
            textarea.addEventListener('input', (e) => {
                autoResize(e.target);

                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    saveNoteContentInline(note.id, e.target.value);
                }, 1000); 
            });
            
            // Forzar el auto-ajuste inicial
            setTimeout(() => {
                autoResize(textarea);
            }, 0);

            // Pie de nota con adjuntos y acciones
            const footer = document.createElement('div');
            footer.className = 'mt-3 flex justify-between items-center pt-2 border-t border-current border-opacity-20';
            
            // Mostrar adjuntos simulados
            const attachmentsDisplay = document.createElement('span');
            attachmentsDisplay.className = 'text-sm flex items-center space-x-2';
            attachmentsDisplay.innerHTML = note.attachments && note.attachments.length > 0
                ? `<i data-lucide="paperclip" class="w-4 h-4 note-action-btn p-0 !bg-transparent"></i><span class="font-semibold">${note.attachments.length} Archivos</span>`
                : '';
            
            const actions = document.createElement('div');
            actions.className = 'flex space-x-2';

            // Botón de Abrir Modal (para editar adjuntos, color, etc.)
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<i data-lucide="edit" class="w-4 h-4"></i>';
            editBtn.className = 'note-action-btn transition';
            editBtn.title = 'Editar Nota (Adjuntos/Color)';
            editBtn.onclick = () => openEditModal('note', note);
            
            // Botón de Eliminar
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
            deleteBtn.className = 'note-action-btn hover:!bg-red-400/50 transition';
            deleteBtn.title = 'Eliminar Nota';
            deleteBtn.onclick = () => openDeleteModal(note.id, 'note', '¿Estás seguro de eliminar esta nota?');

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            
            footer.appendChild(attachmentsDisplay);
            footer.appendChild(actions);

            div.appendChild(textarea);
            div.appendChild(footer);
            
            lucide.createIcons();
            return div;
        };

        // Guarda el contenido de la nota cuando se edita directamente en la cuadrícula
        async function saveNoteContentInline(noteId, content) {
            try {
                if (useLocalStorage) {
                    const notes = loadFromLocalStorage('notes');
                    const noteIndex = notes.findIndex(n => n.id === noteId);
                    if (noteIndex !== -1) {
                        notes[noteIndex].content = content;
                        notes[noteIndex].updatedAt = Date.now();
                        saveToLocalStorage('notes', notes);
                    }
                } else {
                    const noteRef = doc(getCollectionRef('notes'), noteId);
                    await setDoc(noteRef, { content: content, updatedAt: serverTimestamp() }, { merge: true });
                }
            } catch (error) {
                console.error("Error al guardar nota inline:", error);
            }
        }
        
        async function cycleNoteColor(noteId, currentColorClass, noteElement) {
            const currentColors = Object.values(NOTE_BACKGROUND_CLASSES);
            const currentIndex = currentColors.indexOf(currentColorClass);
            const nextIndex = (currentIndex + 1) % currentColors.length;
            const newColorClass = currentColors[nextIndex];

            // 1. Actualizar en Firestore
            try {
                const noteRef = doc(getCollectionRef('notes'), noteId);
                await setDoc(noteRef, { color: newColorClass, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error("Error al cambiar color de nota:", error);
            }
            // 2. Actualizar en el DOM inmediatamente
            noteElement.classList.remove(...currentColors);
            noteElement.classList.add(newColorClass);
        }

        // --- LISTENERS DE FIRESTORE ---

        function setupFirestoreListeners() {
            if (listenersInitialized) return;
            
            // Si estamos usando localStorage, no configurar listeners de Firestore
            if (useLocalStorage) {
                setupLocalStorageListeners();
                listenersInitialized = true;
                return;
            }
            
            // COMPROBACIÓN ADICIONAL Y EXPLÍCITA PARA EVITAR LA CONDICIÓN DE CARRERA DE AUTENTICACIÓN
            const currentUser = auth?.currentUser;
            if (!currentUser || !currentUser.uid) {
                 console.warn("No hay usuario de Firebase activo (o no se ha sincronizado la autenticación). Usando modo local.");
                 useLocalStorage = true;
                 setupLocalStorageListeners();
                 listenersInitialized = true;
                 return;
            }
            // Aseguramos que el global userId sea el mismo.
            userId = currentUser.uid; 

            try {
                // Listener de Tareas
                const tasksQuery = query(getCollectionRef('tasks'));
                onSnapshot(tasksQuery, (snapshot) => {
                    const tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar en JavaScript para evitar errores de índice en Firestore
                    tasks.sort((a, b) => {
                        if (a.completed !== b.completed) {
                            return a.completed ? 1 : -1;
                        }
                        // Ordenar por fecha de creación (más reciente primero)
                        const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt || 0);
                        const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt || 0);
                        return bTime - aTime;
                    });

                    taskList.innerHTML = '';
                    const pendingCount = tasks.filter(t => !t.completed).length;
                    tasksCountDisplay.textContent = `${pendingCount} pendiente${pendingCount === 1 ? '' : 's'}`;
                    
                    if (tasks.length === 0) {
                        taskEmptyState.classList.remove('hidden');
                    } else {
                        taskEmptyState.classList.add('hidden');
                        tasks.forEach(task => {
                            taskList.appendChild(createTaskElement(task));
                        });
                    }
                    lucide.createIcons();
                }, (error) => {
                    // El error de permisos ahora se maneja más arriba, pero lo registramos si ocurre.
                    console.error("Error al escuchar tareas (onSnapshot):", error);
                });
                
                // Listener de Notas
                const notesQuery = query(getCollectionRef('notes'));
                onSnapshot(notesQuery, (snapshot) => {
                    const notes = [];
                    snapshot.forEach(doc => {
                        notes.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar en JavaScript por última actualización (más reciente primero)
                    notes.sort((a, b) => {
                        const aTime = a.updatedAt?.toMillis ? a.updatedAt.toMillis() : (a.updatedAt || 0);
                        const bTime = b.updatedAt?.toMillis ? b.updatedAt.toMillis() : (b.updatedAt || 0);
                        return bTime - aTime;
                    });

                    notesGrid.innerHTML = '';
                    if (notes.length === 0) {
                         notesEmptyState.classList.remove('hidden');
                    } else {
                        notesEmptyState.classList.add('hidden');
                        notes.forEach(note => {
                            notesGrid.appendChild(createNoteElement(note));
                        });
                    }
                    // Forzar el auto-ajuste de altura de las notas
                    notesGrid.querySelectorAll('.note-textarea').forEach(textarea => {
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    });
                    lucide.createIcons();
                }, (error) => {
                    // El error de permisos ahora se maneja más arriba, pero lo registramos si ocurre.
                    console.error("Error al escuchar notas (onSnapshot):", error);
                });
                
                listenersInitialized = true; 
            } catch (e) {
                console.error("Fallo al adjuntar listeners de Firestore (error interno):", e);
            }
        }
        
        // =========================================================
        // 3. LÓGICA DE UI Y UTILIDADES
        // =========================================================

        // --- Navegación de Pestañas (Se mantiene) ---
        const navTabs = document.getElementById('nav-tabs'); 
        
        function renderTabs(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            // LISTA DE PESTAÑAS ACTUALIZADA
            const tabKeys = ['tasks', 'calendar', 'notes', 'converter']; 
            
            tabKeys.forEach(key => {
                const config = TAB_CONFIG[key];
                const button = document.createElement('button');
                button.dataset.tab = key;

                const isDesktopLayout = window.innerWidth >= 768;
                if (isDesktopLayout) {
                    button.className = 'nav-tab flex items-center p-2 rounded-lg text-muted transition hover:bg-tertiary'; 
                    button.innerHTML = `<i data-lucide="${config.icon}" class="w-5 h-5 mr-2"></i><span class="font-medium">${config.title}</span>`;
                } else {
                    button.className = 'nav-tab p-2 rounded-lg text-muted transition hover:bg-tertiary w-full flex-1'; 
                    button.innerHTML = `<i data-lucide="${config.icon}" class="w-6 h-6 mx-auto"></i>`;
                }

                button.addEventListener('click', () => switchTab(key));
                container.appendChild(button);
            });
            lucide.createIcons();
        }

        function switchTab(targetTab) {
            currentTab = targetTab;
            
            // Re-renderizar la barra de navegación para aplicar estilos de mobile/desktop
            renderTabs('nav-tabs'); 

            // Actualizar botones de la barra de navegación (nav-tabs)
            navTabs.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.tab === targetTab) {
                    btn.classList.add('active', 'bg-tertiary', 'text-light');
                    btn.classList.remove('text-muted', 'hover:bg-tertiary');
                } else {
                    btn.classList.remove('active', 'bg-tertiary', 'text-light');
                    btn.classList.add('text-muted', 'hover:bg-tertiary');
                }
            });

            // Mostrar/ocultar paneles de contenido
            document.querySelectorAll('.tab-panel').forEach(panel => {
                if (panel.id.startsWith(targetTab)) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            // Resetear scroll del contenido
            tabContentContainer.scrollTop = 0; 
        }


        // --- Floating Action Button (FAB) y Modal Complejo (Mejorado para Notas) ---
        const fabBtn = document.getElementById('fab-btn');
        const inputModal = document.getElementById('input-modal');
        const inputModalTitle = document.getElementById('input-modal-title');
        const taskNoteForm = document.getElementById('task-note-form');
        const inputTitle = document.getElementById('input-title');
        const inputTitleLabel = document.getElementById('input-title-label');
        const inputDate = document.getElementById('input-date');
        const confirmInputBtn = document.getElementById('confirm-input-btn');
        const cancelInputBtn = document.getElementById('cancel-input-btn');
        const colorSelector = document.getElementById('color-selector');
        const dateField = document.getElementById('date-field');
        const attachmentsField = document.getElementById('attachments-field'); 
        const attachedFilesList = document.getElementById('attached-files-list');
        
        let selectedColorName = 'beige'; 
        
        // --- Funciones para Adjuntos Simulados ---
        window.simulateAttachment = function(type) {
            const fileName = `${type}_${Date.now().toString().slice(-4)}`;
            simulatedAttachments.push({ name: fileName, type: type });
            renderAttachedFiles();
            showMessageModal(`Adjunto simulado (${type}) agregado: ${fileName}`, "Adjunto");
        }
        
        window.removeAttachment = function(index) {
            simulatedAttachments.splice(index, 1);
            renderAttachedFiles();
        }

        function renderAttachedFiles() {
            attachedFilesList.innerHTML = '';
            simulatedAttachments.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex justify-between items-center bg-secondary p-2 rounded-lg text-sm text-light';
                fileDiv.innerHTML = `
                    <span class="truncate">${file.name}</span>
                    <button type="button" onclick="removeAttachment(${index})" class="p-1 text-red-400 hover:text-red-500 transition ml-2" title="Eliminar Adjunto">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                attachedFilesList.appendChild(fileDiv);
            });
            lucide.createIcons();
        }
        
        // --- Funciones para el Selector de Color ---
        function initColorSelector(isTask, initialColor) {
            colorSelector.innerHTML = '';
            
            const colorContainer = colorSelector.closest('div'); // Contenedor padre del selector de color

            // Si es tarea, usamos el color azul por defecto
            if (isTask) {
                selectedColorName = 'blue'; 
                if (colorContainer) {
                    colorContainer.classList.add('hidden');
                }
                return;
            }
            
            // Si es nota, mostramos los pasteles
            if (colorContainer) {
                colorContainer.classList.remove('hidden');
                
                const colorLabel = colorContainer.querySelector('label');
                // FIX: Asegurar que el label exista antes de modificarlo para evitar el TypeError
                if (colorLabel) {
                    colorLabel.textContent = 'COLOR';
                }
            }
            
            selectedColorName = initialColor || 'beige';
            
            Object.entries(NOTE_PASTEL_COLORS).forEach(([name, hex]) => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = hex;
                dot.dataset.colorName = name;

                if (name === selectedColorName) {
                    dot.classList.add('selected');
                }

                dot.addEventListener('click', () => {
                    selectedColorName = name;
                    colorSelector.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                    dot.classList.add('selected');
                });
                colorSelector.appendChild(dot);
            });
            
        }

        /**
         * Abre el modal para CREAR un nuevo elemento (Tarea o Nota).
         */
        fabBtn.addEventListener('click', () => {
            currentDocId = null; // Modo Creación
            simulatedAttachments = []; // Limpiar adjuntos simulados
            
            // La lógica para determinar si crear Tarea o Nota se basa en la pestaña activa
            const type = currentTab === 'tasks' ? 'task' : currentTab === 'notes' ? 'note' : null;
            
            if (!type) {
                // MODIFICADO: El FAB no hace nada en la pestaña del convertidor o calendario
                showMessageModal("El botón (+) solo funciona en las pestañas de Tareas y Notas.", "Aviso");
                return;
            }
            
            taskNoteForm.reset();
            renderAttachedFiles(); // Mostrar lista de adjuntos vacía
            
            // Configuración del Modal
            inputModalTitle.textContent = type === 'task' ? 'Nueva Tarea' : 'Nueva Nota';
            inputTitleLabel.textContent = type === 'task' ? 'TÍTULO' : 'CONTENIDO';
            inputTitle.placeholder = type === 'task' ? 'Ej. Comprar leche' : 'Escribe tu nota aquí...';
            confirmInputBtn.textContent = type === 'task' ? 'Crear Tarea' : 'Crear Nota';
            confirmInputBtn.dataset.type = type;
            
            // Control de campos específicos
            const isTask = type === 'task';
            if (isTask) {
                dateField.classList.remove('hidden');
            } else {
                dateField.classList.add('hidden');
            }
            attachmentsField.classList.remove('hidden'); // Ambos pueden tener adjuntos
            
            initColorSelector(isTask);

            inputModal.classList.remove('hidden');
            inputTitle.focus();
            lucide.createIcons(); 
        });
        
        /**
         * Abre el modal para EDITAR un elemento existente (Nota).
         */
        function openEditModal(type, data) {
            if (type !== 'note') return; // Solo permite edición avanzada de notas por ahora
            
            currentDocId = data.id; // Almacenar ID para la actualización
            simulatedAttachments = data.attachments || []; // Cargar adjuntos existentes
            
            taskNoteForm.reset();
            renderAttachedFiles(); 

            // Rellenar campos
            inputModalTitle.textContent = 'Editar Nota';
            inputTitleLabel.textContent = 'CONTENIDO';
            inputTitle.value = data.content;
            confirmInputBtn.textContent = 'Guardar Cambios';
            confirmInputBtn.dataset.type = 'note';
            
            // Ocultar campos innecesarios
            dateField.classList.add('hidden');
            attachmentsField.classList.remove('hidden'); 
            
            // Inicializar selector de color con el color actual
            const currentColorClass = data.color.replace('note-', '');
            initColorSelector(false, currentColorClass); 

            inputModal.classList.remove('hidden');
            inputTitle.focus();
            lucide.createIcons(); 
        }

        cancelInputBtn.addEventListener('click', () => {
            inputModal.classList.add('hidden');
        });

        // Manejar el envío del formulario (Crear o Editar)
        taskNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = confirmInputBtn.dataset.type;
            const content = inputTitle.value.trim();
            
            if (!content) {
                showMessageModal("El contenido no puede estar vacío.", "Error de Validación");
                return;
            }
            
            if (type === 'task') {
                const dateValue = inputDate.value; 
                await saveTask(content, dateValue, simulatedAttachments);
            } else if (type === 'note') {
                await saveNote(content, selectedColorName, simulatedAttachments); 
            }
            
            inputModal.classList.add('hidden');
        });

        // --- Modal de Confirmación de Eliminación (Se mantiene) ---
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const deleteModalText = document.getElementById('delete-modal-text');

        function openDeleteModal(docId, docType, message) {
            deleteModalText.textContent = message;
            confirmDeleteBtn.dataset.docId = docId;
            confirmDeleteBtn.dataset.type = docType;
            deleteModal.classList.remove('hidden');
        }

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            const docId = confirmDeleteBtn.dataset.docId;
            const docType = confirmDeleteBtn.dataset.type;
            
            if (!docId || !docType) {
                console.error("Intento de eliminación sin ID o tipo.");
                deleteModal.classList.add('hidden');
                return;
            }

            const collectionName = docType === 'task' ? 'tasks' : 'notes';
            
            try {
                if (useLocalStorage) {
                    const items = loadFromLocalStorage(collectionName);
                    const filteredItems = items.filter(item => item.id !== docId);
                    saveToLocalStorage(collectionName, filteredItems);
                    if (collectionName === 'tasks') {
                        renderTasks(filteredItems);
                    } else {
                        renderNotes(filteredItems);
                    }
                } else {
                    const docRef = doc(getCollectionRef(collectionName), docId);
                    await deleteDoc(docRef);
                }
            } catch (error) {
                console.error(`Error al eliminar documento (${docType}):`, error);
                showMessageModal("Error al eliminar. Verifique la conexión.", "Error");
            } finally {
                deleteModal.classList.add('hidden');
            }
        });
        
        // --- LÓGICA DEL CONVERTIDOR (REAL) ---
        function initConverter() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const convertBtn = document.getElementById('convert-btn');
            const loadingDisplay = document.getElementById('convert-loading');
            const successDisplay = document.getElementById('convert-success');
            
            let selectedFile = null;
            let pdfBlob = null; // Almacenar el PDF generado

            // Resaltar zona de drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // Manejar clic en la zona
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            function handleFile(file) {
                if (file && (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || file.name.endsWith('.docx'))) {
                    selectedFile = file;
                    fileNameDisplay.textContent = file.name;
                    convertBtn.disabled = false;
                    convertBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    loadingDisplay.classList.add('hidden');
                    successDisplay.classList.add('hidden');
                    pdfBlob = null; // Resetear PDF anterior
                } else {
                    selectedFile = null;
                    fileNameDisplay.textContent = "Por favor, selecciona un archivo .docx";
                    convertBtn.disabled = true;
                    convertBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    showMessageModal("Tipo de archivo no válido. Solo se aceptan archivos .docx.", "Error");
                }
            }
            
            // Conversión real DOCX a PDF
            convertBtn.addEventListener('click', async () => {
                if (!selectedFile) return;
                
                loadingDisplay.classList.remove('hidden');
                successDisplay.classList.add('hidden');
                convertBtn.disabled = true;

                try {
                    // Paso 1: Leer el archivo DOCX como ArrayBuffer
                    const arrayBuffer = await selectedFile.arrayBuffer();
                    
                    // Paso 2: Convertir DOCX a HTML usando mammoth
                    const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                    const htmlContent = result.value;
                    
                    // Paso 3: Crear un elemento temporal para renderizar el HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.width = '210mm'; // Tamaño A4
                    tempDiv.style.padding = '20mm';
                    tempDiv.style.fontFamily = 'Arial, sans-serif';
                    tempDiv.style.fontSize = '12pt';
                    tempDiv.style.lineHeight = '1.6';
                    tempDiv.style.color = '#000';
                    tempDiv.style.backgroundColor = '#fff';
                    tempDiv.innerHTML = htmlContent;
                    document.body.appendChild(tempDiv);
                    
                    // Paso 4: Convertir HTML a PDF usando html2pdf
                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: selectedFile.name.replace('.docx', '.pdf'),
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2, 
                            useCORS: true,
                            logging: false,
                            letterRendering: true
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    };
                    
                    // Esperar un momento para que el DOM se renderice completamente
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    await html2pdf().set(opt).from(tempDiv).save();
                    
                    // Limpiar elemento temporal
                    document.body.removeChild(tempDiv);
                    
                    // Mostrar éxito
                    loadingDisplay.classList.add('hidden');
                    successDisplay.classList.remove('hidden');
                    
                    // Resetear el input para permitir cargar el mismo archivo de nuevo
                    fileInput.value = ''; 
                    selectedFile = null;
                    fileNameDisplay.textContent = '';
                    convertBtn.disabled = false;
                    
                } catch (error) {
                    console.error("Error en la conversión:", error);
                    loadingDisplay.classList.add('hidden');
                    showMessageModal(`Error al convertir el archivo: ${error.message}`, "Error");
                    convertBtn.disabled = false;
                }
            });
            
        }
        

        // --- Modal de Mensajes (Reemplazo de alert()) ---
        function showMessageModal(message, title = "Aviso") {
             const existingModal = document.getElementById('message-modal');
             if (existingModal) existingModal.remove();

             const modalHtml = `
                <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
                    <div class="bg-secondary p-6 rounded-xl shadow-2xl w-full max-w-sm border border-base">
                        <h3 class="text-xl font-bold mb-4 ${title === 'Error' ? 'text-red-400' : 'accent-pink-text'}">${title}</h3>
                        <p class="text-light mb-6">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('message-modal').remove()" class="accent-pink-bg hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Aceptar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

    </script>
</body>
</html>